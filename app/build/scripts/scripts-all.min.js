function ViewManager(e){e=e||{},this.currentView=null,this.views={},this.views[ViewManager.VIEWS.INTRO]=new IntroView({el:"#introContainer"}),this.views[ViewManager.VIEWS.MENU]=new MenuView({el:"#menuContainer"}),this.views[ViewManager.VIEWS.FIELD]=new FieldView({el:"#fieldContainer"})}function NPC(){}function Ally(e){e.color=e.color||2189467,NPC.prototype.constructor.call(this,e)}function Enemy(e){e.color=e.color||10551311,NPC.prototype.constructor.call(this,e)}function Cursor(e){e=e||{};var t=this.graphics=new PIXI.Graphics,i=[0,3355443,1752220,3447003,15965202,15528177,8359053,9807270,16777215];t.beginFill(e.color||i[2]),t.moveTo(10,10),t.lineTo(10,50),t.lineTo(50,47),t.drawCircle(30,55,20),t.endFill(),this.dx=0,this.dy=0,this.maxDx=10,this.maxDy=10,this.isFrozen=!1,t.hitArea=new PIXI.Circle(100,100,50),t.setInteractive(!0),t.click=function(){console.log("hit rect")},_.extend(this,Backbone.Events),this.listenTo(Key,"keydown",this.onKeyDown),this.listenTo(Key,"keyup",this.onKeyUp)}function Grid(e,t,i,n){i=i||100,n=n||100;for(var o,s,r=4,a=new PIXI.Graphics,h=0;t>h;h++)for(var l=0;e>l;l++)o=h*i,s=l*n,r=12,a.lineStyle(1,8359053,1),a.moveTo(o+r,s),a.lineTo(o+i-r,s),a.moveTo(o,s+r),a.lineTo(o,s+n-r);return a}function CornerBox(e,t,i){"undefined"==typeof e&&(e=12245589);var n=20,o=10,s=8;t=t||n,i=i||n;var r=new PIXI.Graphics;return r.lineStyle(3,e,1),r.moveTo(s+o,o),r.lineTo(o,o),r.lineTo(o,s+o),r.moveTo(t-s-o,o),r.lineTo(t-o,o),r.lineTo(t-o,s+o),r.moveTo(o,i-s-o),r.lineTo(o,i-o),r.lineTo(s+o,i-o),r.moveTo(t-s-o,i-o),r.lineTo(t-o,i-o),r.lineTo(t-o,i-s-o),r}function Box(e,t,i){"undefined"==typeof e&&(e=12245589);var n=20;t=t||n,i=i||n;var o=new PIXI.Graphics;return o.lineStyle(3,e,1),o.moveTo(0,0),o.drawRect(10,10,10+t,10+i),o}function Circle(e,t,i,n){"undefined"==typeof i&&(i=10551311),n=n||10;var o=new PIXI.Graphics;return o.beginFill(i),o.drawCircle(e,t,n),o.endFill(),o}function RangeHighlighter(e){e=e||{},this.gridView=e.gridView,this.gridModel=this.gridView.gridModel,this.cellWidth=this.gridView.cellWidth,this.cellHeight=this.gridView.cellHeight,this.overlay=new PIXI.Graphics,this.gridView.pixiContainer.addChild(this.overlay),_.extend(this,Backbone.Events);var t=this.gridView.selectionManager;this.listenTo(t,"selection:start",this.onSelectionStart),this.listenTo(t,"selection:end",this.onSelectionEnd),this.listenTo(t,"selection:target",this.onSelectionTarget),this.listenTo(t,"selection:reset",this.onSelectionReset)}function SelectionManager(e){e=e||{},this.gridView=e.gridView,this.gridModel=this.gridView.gridModel,this.cursor=this.gridView.cursor,this.cellWidth=this.gridView.cellWidth,this.cellHeight=this.gridView.cellHeight,this.setupSelectionGraphics(this.gridView.pixiContainer),this.topMenu=document.getElementById("topMenu"),this.currentTile=this.gridModel.getTile(0,0),this.selectedStartTile=null,this.selectedEndTile=null,this.selectedTargetTile=null,this.selectMode=SelectionManager.MODE.NONE,_.extend(this,Backbone.Events),this.listenTo(Key,"keyup",this.onKeyUp),this.updatePathDebounced=_.debounce(this.updatePath,10)}ViewManager.prototype.loadView=function(e){var t=this.views[e],i=this.currentView;if(t!==i){if(!t)return void console.error("Tried to load an unknown view: "+e);i&&i.leaveView(t),t.enterView(i),this.currentView=t}},ViewManager.VIEWS={INTRO:"intro",MENU:"menu",FIELD:"field"},NPC.prototype.constructor=function(e){e=e||{},this.tileX=e.x,this.tileY=e.y;var t=e.cellWidth||100,i=e.cellHeight||100,n=this.tileX*t+t/2,o=this.tileY*i+i/2;this.piece=new Circle(0,0,e.color||0),this.piece.position.set(n,o),this.name=Utils.randomName(),this.moved=!1,this.moveRange=Math.floor(3*Math.random())+3,this.attackRange=Math.floor(2*Math.random())+1},Ally.prototype=new NPC,Enemy.prototype=new NPC,Cursor.prototype.update=function(){this.isFrozen||(this.graphics.position.x+=this.dx,this.graphics.position.y+=this.dy)},Cursor.prototype.onKeyDown=function(e){var t=this.maxDx,i=this.maxDy;Key.matches(e.keyCode,["LEFT","A"])?this.dx=-t:Key.matches(e.keyCode,["UP","W"])?this.dy=-i:Key.matches(e.keyCode,["RIGHT","D"])?this.dx=+t:Key.matches(e.keyCode,["DOWN","S"])&&(this.dy=+i)},Cursor.prototype.onKeyUp=function(e){var t=0,i=0;Key.matches(e.keyCode,["LEFT","A"])?this.dx=-t:Key.matches(e.keyCode,["UP","W"])?this.dy=-i:Key.matches(e.keyCode,["RIGHT","D"])?this.dx=+t:Key.matches(e.keyCode,["DOWN","S"])&&(this.dy=+i)};var FieldView=Backbone.View.extend({turn:null,allies:[],enemies:[],initialize:function(e){e=e||{},this.chatView=new ChatView,this.battleView=new BattleView,this.gridView=new GridView,this.gridView.render(),this.stage=this.gridView.stage,this.renderer=this.gridView.renderer,this.selectionManager=this.gridView.selectionManager,this.actionMenuView=new ActionMenuView({selectionManager:this.selectionManager}),this.turn=e.firstTurn||FieldView.TURN.PLAYER,this.addedPIXIView=!1,this.animateBound_=this.animate.bind(this),this.listenTo(this.actionMenuView,"close",this.onActionMenuClose)},render:function(){this.addedPIXIView||(this.el.appendChild(this.renderer.view),this.addedPIXIView=!0),this.animateBound_()},enterView:function(){this.render()},leaveView:function(){var e=new TWEEN.Tween(b).to({blurX:50},800).start();e=new TWEEN.Tween(g.pixiContainer).to({rotation:.3,alpha:0},800).start()},completeTurn:function(){this.turn===FieldView.TURN.PLAYER?this.turn=FieldView.TURN.AI:this.turn===FieldView.TURN.AI&&(this.turn=FieldView.TURN.PLAYER)},animate:function(){var e=Utils.now(),t=e-this.lastTime;this.lastTime=e,this.update(t),TWEEN.update(e),this.renderer.render(this.stage),requestAnimationFrame(this.animateBound_)},update:function(e){this.gridView.update(e),this.selectionManager.update(e)},onActionMenuClose:function(){this.selectionManager.onActionSet()}});FieldView.TURN={PLAYER:"player",AI:"ai"};var IntroView=Backbone.View.extend({}),MenuView=Backbone.View.extend({}),Audio={audioTags:[document.getElementById("sound1"),document.getElementById("sound2")],dynamicTag:document.getElementById("dynamicSound"),play:function(e,t){"undefined"==typeof e&&console.error("Bad track: Tried to play a missing sound");var i=this.audioTags[e];t&&(i.volume=t),i.play()},playSrc:function(e,t){this.dynamicTag.src=e,t&&(this.dynamicTag.volume=t),this.dynamicTag.oncanplay=function(){this.play()}}},Key={pressed:{},keycodeMap:{LEFT:37,UP:38,RIGHT:39,DOWN:40,W:87,A:65,S:83,D:68,BACKSPACE:8,ENTER:13,SPACE:32,ESC:27,COMMA:188,PERIOD:190,SLASH:191,L_SQ_BRACKET:219,R_SQ_BRACKET:221,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53},isDown:function(e){return this.pressed[e]},anyDown:function(){for(var e=this.pressed,t=this.keycodeMap,i=Object.keys(t),n=0;n<i.length;n++)if(e[t[i[n]]]===!0)return!0;return!1},onKeyDown:function(e){this.pressed[e.keyCode]=!0,Key.trigger("keydown",e)},onKeyUp:function(e){this.pressed[e.keyCode]=void 0,Key.trigger("keyup",e)},matches:function(e,t){for(var i=0;i<t.length;i++){var n=t[i];if(e===this.keycodeMap[n])return!0}return!1},isPressed:function(e){for(var t=0;t<e.length;t++){var i=e[t];if(!this.keycodeMap[i])return void console.error("Key not found");if(this.pressed[this.keycodeMap[i]]===!0)return!0}return!1}};_.extend(Key,Backbone.Events),document.body.onkeydown=function(e){Key.onKeyDown(e)},document.body.onkeyup=function(e){Key.onKeyUp(e)};var Names={male:["Jacob","Mason","Ethan","Noah","William","Liam","Jayden","Michael","Alexander","Aiden"],female:["Sophia","Emma","Isabella","Olivia","Ava","Emily","Abigail","Mia","Madison","Elizabeth"],random:function(e){return e=e||Math.random()>.5?"male":"female","male"==e?this.male[Math.floor(Math.random()*this.male.length)]:this.female[Math.floor(Math.random()*this.female.length)]}},Utils={now:function(){return performance&&performance.now?performance.now():Date.now()},randomRGB:function(){return{r:Math.floor(255*Math.random()),g:Math.floor(255*Math.random()),b:Math.floor(255*Math.random())}},randomColor:function(){var e=Math.floor(255*Math.random()),t=Math.floor(255*Math.random()),i=Math.floor(255*Math.random());return"rgb("+e+","+t+","+i+")"},randomHex:function(){var e=this.randomRGB();return this.rgbToHex(e.r,e.g,e.b)},rgbToHex:function(e,t,i){var n=e.toString(16),o=t.toString(16),s=i.toString(16);return n="0"==n?"00":n,o="0"==o?"00":o,s="0"==s?"00":s,parseInt(n+o+s,16)},randomName:function(){return Names.random()}},ActionMenuView=Backbone.View.extend({template:_.template($("#actionMenuTemplate").html()),el:"#actionMenuContainer",actionSet:null,isOpen:!1,events:{"click .action-option":"onActionClick","mouseover .action-option":"onActionHover"},initialize:function(e){e=e||{},this.actionSet=e.actionSet||0,this.selectionManager=e.selectionManager,_.extend(this,Backbone.Events),this.listenTo(this.selectionManager,"selection:target",this.onTargetTileSelected)},render:function(){if(!this.isOpen){var e=this.template({actionOptions:ActionSets[this.actionSet]});this.$el.hide().html(e).fadeIn(),this.listenTo(Key,"keyup",this.onKeyUp),this.isOpen=!0}},close:function(e){this.isOpen&&(this.stopListening(Key,"keyup"),this.isOpen=!1,this.$el.delay(200).fadeOut(e))},loadActions:function(e){var t=ActionSets[e];t&&(this.actionSet=e,this.render())},onTargetTileSelected:function(){this.loadActions(0);var e=this.$el.find(".action-option")[0];this.highlightOption(e)},onActionHover:function(e){this.highlightOption(e.target)},onActionClick:function(e){if(e.target){var t=$(e.target),i=t.data("action-index");t.addClass("active"),this.close(function(){this.trigger("close",{actionSet:ActionSets[this.actionSet],selectedIndex:i})}.bind(this))}},highlightOption:function(e){if(e){var t=this.$el.find(".action-option");t.removeClass("selected"),e.classList.add("selected")}},onKeyUp:function(e){var t=this.$el.find(".action-option"),i=t.filter(".selected"),n=t.length,o=i.data("action-index"),s=0===o?n-1:o-1,r=o===n-1?0:o+1;Key.matches(e.keyCode,["SPACE","ENTER"])?this.onActionClick({target:i}):Key.matches(e.keyCode,["UP"])?this.highlightOption(t[s]):Key.matches(e.keyCode,["DOWN"])?this.highlightOption(t[r]):Key.matches(e.keyCode,["LEFT"])||Key.matches(e.keyCode,["RIGHT"])}}),ActionSets=[["Fire","Water","Wait","Cancel"],["Light","Water","Wait","Cancel"],["Heal","Light","Wait","Cancel"]],BattleView=Backbone.View.extend({}),ChatView=Backbone.View.extend({}),GridModel=Backbone.Model.extend({initialize:function(e){e=e||{},this.rowN=e.rowN||50,this.colN=e.colN||100;for(var t=[],i=0;i<this.rowN;i++){var n=new Array(this.colN);t.push(n)}this.board=t},setTile:function(e,t,i){"undefined"==typeof i&&(i=t.y,t=t.x);var n=this.board[t][i];return this.board[t][i]=e,n},getTile:function(e,t){return"undefined"==typeof t&&(t=e.y,e=e.x),this.board[e]?this.board[e][t]:null},attemptMovement:function(e,t){var i=this.getTile(e);return i instanceof Ally&&GridModel.tileDistance(e,t)<=i.moveRange?(this.setTile(null,e),this.setTile(i,t),i.moved=!0,!0):!1}});GridModel.tileDistance=function(e,t){var i=Math.abs(t.x-e.x),n=Math.abs(t.y-e.y);return i+n};var GridView=Backbone.View.extend({gridModel:null,stage:null,renderer:null,cursor:null,selectionManager:null,rangeHighlighter:null,stageBounds:{left:50,right:window.innerWidth-50,up:50,down:window.innerHeight-4-50},initialize:function(e){e=e||{},this.rowN=e.rowN||50,this.colN=e.colN||100,this.cellWidth=e.cellWidth||70,this.cellHeight=e.cellHeight||70;var t=[0,3355443,1752220,3447003,15965202,15528177,8359053,9807270,16777215,8421504];this.stage=new PIXI.Stage(t[8]),this.pixiContainer=new PIXI.DisplayObjectContainer,this.stage.addChild(this.pixiContainer);var i=window.innerWidth,n=window.innerHeight-4;this.renderer=PIXI.autoDetectRenderer(i,n),window.onresize=this.onResize.bind(this),this.gridModel=new GridModel({rowN:this.rowN,colN:this.colN})},render:function(){this.grid=new Grid(this.rowN,this.colN,this.cellWidth,this.cellHeight),this.pixiContainer.addChild(this.grid),this.cursor=new Cursor,this.selectionManager=new SelectionManager({gridView:this}),this.rangeHighlighter=new RangeHighlighter({gridView:this}),this.addCharacters()},addCharacters:function(){var e=3,t=10,n=[],o=[];for(i=0;e>i;i++){var s=new Ally({x:Math.floor(5*Math.random()),y:Math.floor(5*Math.random()),cellWidth:this.cellWidth,cellHeight:this.cellHeight});n.push(s),this.pixiContainer.addChild(s.piece),this.gridModel.setTile(s,s.tileX,s.tileY)}for(i=0;t>i;i++){var r=new Enemy({x:Math.floor(10*Math.random()+5),y:Math.floor(10*Math.random()+5),cellWidth:this.cellWidth,cellHeight:this.cellHeight});o.push(r),this.pixiContainer.addChild(r.piece),this.gridModel.setTile(r,r.tileX,r.tileY)}},movePiece:function(e,t){var i=this.selectionManager.getPositionFromTile(t),n=this.gridModel.getTile(e);if(n){var o=n.piece,s=this.gridModel.attemptMovement(e,t);if(s){var r=i.x,a=i.y,h=o.position.x,l=o.position.y,c=(r-h)*(r-h)+(a-l)*(a-l),d=c/256;new TWEEN.Tween(o.position).to({x:r,y:a},d).start()}}},attackPiece:function(){},update:function(e){this.cursor.update(e),this.updateStageBounds(e)},updateStageBounds:function(){Key.anyDown()===!0&&(this.cursor.graphics.getBounds().x<this.stageBounds.left&&(this.stage.worldTransform.tx+=20),this.cursor.graphics.getBounds().x>this.stageBounds.right&&(this.stage.worldTransform.tx-=20),this.cursor.graphics.getBounds().y<this.stageBounds.up&&(this.stage.worldTransform.ty+=20),this.cursor.graphics.getBounds().y>this.stageBounds.down&&(this.stage.worldTransform.ty-=20))},onResize:function(){this.renderer.resize(window.innerWidth,window.innerHeight)}});_.extend(RangeHighlighter.prototype,{onSelectionStart:function(e){this.overlay.clear();var t=this.gridModel.getTile(e);t&&this.highlight(t,e)},onSelectionEnd:function(){},onSelectionTarget:function(){this.overlay.clear()},onSelectionReset:function(){this.overlay.clear()},highlight:function(e,t){var i=e.moveRange,n=e.attackRange;this.buildOverlay(t,i,n)},cleanOverlay:function(){this.overlay.clear()},buildOverlay:function(e,t,i){var n=5,o=.5,s=this.cellWidth,r=this.cellHeight,a=this.overlay;a.clear(),a.lineStyle(0);var h=0;console.log(e,t,i);var l,c,d,u;for(d=0;t>=d;d++)for(u=0;d>=u;u++)l=(e.x+d-t)*s,c=(e.y+u)*r,a.beginFill(h,o),a.drawRect(l+n,c+n,s-2*n,r-2*n),a.endFill(),0!==u&&(l=(e.x+d-t)*s,c=(e.y-u)*r,a.beginFill(h,o),a.drawRect(l+n,c+n,s-2*n,r-2*n),a.endFill());for(d=1;t>=d;d++)for(u=0;t-d>=u;u++)l=(e.x+d)*s,c=(e.y+u)*r,a.beginFill(h,o),a.drawRect(l+n,c+n,s-2*n,r-2*n),a.endFill(),0!==u&&(l=(e.x+d)*s,c=(e.y-u)*r,a.beginFill(h,o),a.drawRect(l+n,c+n,s-2*n,r-2*n),a.endFill())}}),_.extend(SelectionManager.prototype,{setupSelectionGraphics:function(e){this.selectBox=new Box(12245589,this.cellWidth-30,this.cellHeight-30),this.startBox=new Box(36095,this.cellWidth-30,this.cellHeight-30),this.endBox=new Box(16737792,this.cellWidth-30,this.cellHeight-30),this.targetBox=new Box(16711936,this.cellWidth-30,this.cellHeight-30),this.path=new PIXI.Graphics,this.path.lineStyle(2,16777215,1),e.addChild(this.cursor.graphics),e.addChild(this.selectBox),e.addChild(this.startBox),e.addChild(this.endBox),e.addChild(this.targetBox),e.addChild(this.path)},onKeyUp:function(e){Key.matches(e.keyCode,["ENTER","SPACE"])?this.selectMode===SelectionManager.MODE.NONE?this.setStart():this.selectMode===SelectionManager.MODE.STARTED?this.setEnd():this.selectMode===SelectionManager.MODE.TARGET&&this.setTarget():Key.matches(e.keyCode,["SLASH"])&&this.resetSelection()},update:function(){this.updateSelectBox(),this.selectMode===SelectionManager.MODE.STARTED&&this.updatePathDebounced()},updateSelectBox:function(){var e=this.getGridSnapPosition(this.cursor.graphics.position);this.selectBox.position.x=e.x,this.selectBox.position.y=e.y,this.currentTile=this.getCurrentTile();var t=this.gridView.gridModel.getTile(this.currentTile);t?(this.topMenu.classList.contains("hide")&&Audio.play(0,.1),this.topMenu.innerText=t.name,this.topMenu.classList.remove("hide")):this.topMenu.classList.add("hide")},setStart:function(){this.clearPath();var e=this.getCurrentTile(),t=this.selectBox;this.gridModel.getTile(e)&&(this.startBox.position.set(t.position.x,t.position.y),this.selectedStartTile=e,this.selectMode=SelectionManager.MODE.STARTED),this.trigger("selection:start",e)},setEnd:function(){var e=this.selectBox,t=this.getCurrentTile(),i=this.selectedStartTile,n=i&&this.gridModel.getTile(i),o=n&&n.moveRange,s=GridModel.tileDistance(i,t);this.selectedEndTile=t,o&&o>=s?(this.endBox.position.set(e.position.x,e.position.y),this.gridView.movePiece(i,t),this.selectMode=SelectionManager.MODE.TARGET,this.trigger("selection:end",t),Audio.play(1,.3)):this.resetSelection()},setTarget:function(){var e=this.selectBox,t=this.getCurrentTile();this.selectedTargetTile=t,this.selectedEndTile===this.selectedTargetTile,this.targetBox.position.set(e.position.x,e.position.y),this.gridView.attackPiece(this.selectedStartTile,t),this.selectMode=SelectionManager.MODE.ACTION,this.cursor.isFrozen=!0,this.trigger("selection:target",t),Audio.playSrc("sounds/click3.wav",.3)},onActionSet:function(){this.selectMode=SelectionManager.MODE.NONE,this.cursor.isFrozen=!1,Audio.playSrc("sounds/click3.wav",.3)},resetSelection:function(){var e=this.selectBox,t=this.getCurrentTile();this.targetBox.position.set(e.position.x,e.position.y),this.selectMode=SelectionManager.MODE.NONE,this.clearPath(),this.trigger("selection:reset",t)},updatePath:function(){if(this.selectMode==SelectionManager.MODE.STARTED){var e=this.pathPoints,t=this.path,i=this.getGridSnapPosition(this.selectBox.position);if(JSON.stringify(e[e.length-1])!==JSON.stringify(i)){e.push(i);var n=this.cellWidth/2;t.clear(),t.lineStyle(5,5000268,1),t.moveTo(e[0].x+n,e[0].y+n);for(var o=1;o<this.pathPoints.length;o++){var s=e[o];t.lineTo(s.x+n,s.y+n)}}}},clearPath:function(){this.pathPoints=[],this.path.clear()},getCurrentTile:function(){return this.getTileFromPosition(this.cursor.graphics.position)},getGridSnapPosition:function(e){return{x:this.cellWidth*Math.floor(e.x/this.cellWidth),y:this.cellHeight*Math.floor(e.y/this.cellHeight)}},getTileFromPosition:function(e){return{x:Math.floor(e.x/this.cellWidth),y:Math.floor(e.y/this.cellHeight)}},getPositionFromTile:function(e,t){return"undefined"==typeof t&&(t=e.y,e=e.x),{x:this.cellWidth*e+this.cellWidth/2,y:this.cellHeight*t+this.cellHeight/2}}}),SelectionManager.MODE={NONE:0,STARTED:1,TARGET:2,ACTION:3};var Application=function(e){_.extend(this,Backbone.Events,e),this.isPaused=!1};if(_.extend(Application.prototype,{start:function(){this.viewManager=new ViewManager,this.viewManager.loadView(ViewManager.VIEWS.FIELD),this.isPaused=!1},pause:function(){this.isPaused||this.trigger("pause"),this.isPaused=!0},resume:function(){this.isPaused&&this.trigger("resume"),this.isPaused=!1}}),"TESTING"!==window.environment){var game=new Application;game.start()}